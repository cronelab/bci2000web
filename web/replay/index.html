<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Replay Dashboard</title>
    <link
      href="../node_modules/bootstrap/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
	<link href="replay.css" rel="stylesheet" />
	<script src="../node_modules/jquery/dist/jquery.min.js"></script>
	<script src="../node_modules/bci2k/dist/bci2k.min.js"></script>
	<script src="../node_modules/tether/dist/js/tether.min.js"></script>
    <script src="../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../system/bci2kconfig.js"></script>
 
  </head>

  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">BCI2000Web</a>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">
        <div class="col">
          <div class="card">
            <div class="card-header"><h3 class="card-title">Subjects</h3></div>
            <ul class="list-group" id="bci-subjects">
            </ul>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-header"><h3 class="card-title">Tasks</h3></div>
            <ul class="list-group" id="bci-tasks">
            </ul>
          </div>
        </div>
	  </div>
	  <div class="row">
			<div class="card">
					<div class="card-header"><h3 class="card-title">Data files</h3></div>
					<ul class="list-group" id="bci-data">
					</ul>
				  </div>
		
	  </div>
	</div>
	
	<script>
		var bci = new BCI2K.Connection();

$( document ).ready( function() {
	bci.connect();
	bci.onconnect = function() {
		console.log("Connected")
	// 	// getReplayFiles(); // src/replay.js
	// 	monitorSystemState();
	}

} );


		function launchSession( patient, task, file ) {
			var datafile = `../data/${patient}/${task}/${file}.dat`
			
			var script = "Reset System; "
			script += "Startup System localhost; "
			script += "Start executable SpectralSignalProcessingMod --local; ";
			script += "Start executable DummyApplication --local; ";
			script += "Start executable FilePlayback --local --FileFormat=Null --PlaybackStates=1 --PlaybackFileName=" + datafile + "; ";
			script += "Wait for Connected; ";
			script += "Load Parameterfile ../parms.ecog/SpectralSigProc.prm; ";

			script += "Set Parameter WSSpectralOutputServer *:20203; ";
			script += "Set Parameter WSConnectorServer *:20323; ";
			script += "Set Parameter WSSourceServer *:20100; ";

			script += "Set Config; ";
			script += "Wait for Resting; ";
			script += "Start; ";

			bci.execute( script );
		}


		fetch('../../subjects').then(x => x.json()).then(subj => {
			subj.map(individualSubj => {
				var subjButton = document.createElement('li')
				subjButton.classList.add('list-group-item')
				subjButton.innerHTML = individualSubj
				subjButton.onclick = function(){getDataFiles(individualSubj)}
				document.getElementById('bci-subjects').appendChild(subjButton)
			})
		})
		function getDataFiles(subj){
			let bciTaskId = document.getElementById('bci-tasks');			
			var arr = [].slice.call(document.getElementById('bci-tasks').children).map(x=>x.remove())
			fetch(`../../api/${subj}`).then(y => y.json()).then(task => {
				task.map(individualTasks => {
				var taskButton = document.createElement('li')
				taskButton.classList.add('list-group-item')
				taskButton.id = 'task'
				taskButton.innerHTML = individualTasks
				taskButton.onclick = function(){
					var arr = [].slice.call(document.getElementById('bci-data').children).map(x=>x.remove())
					fetch(`../../api/${subj}/${individualTasks}`).then(z => z.json()).then(data => {
						data.map(datFile => {
							var datFileButton = document.createElement('li')
							datFileButton.classList.add('list-group-item')
							datFileButton.innerHTML = datFile
							datFileButton.onclick = function(){
								launchSession(subj,individualTasks,datFile);
							}
					document.getElementById('bci-data').appendChild(datFileButton)
					})
				})
				}
				document.getElementById('bci-tasks').appendChild(taskButton)
			})



			})
		}
	</script>

    <!-- <script src="replay.js"></script>
    <script src="dashboard.js"></script> -->
  </body>
</html>
